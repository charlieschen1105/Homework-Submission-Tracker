<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>全科作业登记系统</title>
    <!-- 核心库 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <!-- 图标库 -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

    <style>
        :root {
            --primary: #4e54c8;
            --accent: #8f94fb;
            --success: #00c853;
            --danger: #ff5252;
            --bg: #f4f6f9;
            --card-bg: #ffffff;
            --text-main: #2c3e50;
            --text-sub: #95a5a6;
            --shadow: 0 4px 12px rgba(0,0,0,0.05);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0; background: var(--bg); color: var(--text-main);
            -webkit-tap-highlight-color: transparent; user-select: none;
        }

        /* --- 登录/注册全屏蒙版 --- */
        .auth-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px; box-sizing: border-box; color: white;
        }
        .auth-card {
            background: white; color: var(--text-main); width: 100%; max-width: 320px;
            padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .auth-title { font-size: 24px; font-weight: 700; margin-bottom: 20px; text-align: center; color: var(--primary); }
        .auth-input {
            width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd;
            border-radius: 10px; box-sizing: border-box; font-size: 16px; background: #f9f9f9;
        }
        .auth-btn {
            width: 100%; padding: 12px; background: var(--primary); color: white;
            border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer;
            margin-top: 10px;
        }
        .auth-btn.secondary { background: #f0f0f0; color: #666; margin-top: 10px; }
        .class-select-group {
            max-height: 150px; overflow-y: auto; margin-bottom: 15px; border: 1px solid #eee; padding: 10px; border-radius: 8px;
        }
        .checkbox-item { display: flex; align-items: center; margin-bottom: 8px; font-size: 14px; }
        .checkbox-item input { margin-right: 10px; transform: scale(1.2); }

        /* --- 主界面样式 --- */
        .header-section {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            padding: 20px 20px 10px; border-radius: 0 0 24px 24px; color: white;
            position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 15px rgba(78, 84, 200, 0.3);
        }

        .nav-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .app-title { font-size: 20px; font-weight: 700; display: flex; align-items: center; gap: 8px; }
        .user-info { font-size: 12px; background: rgba(0,0,0,0.2); padding: 4px 10px; border-radius: 10px; }
        .menu-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px; border-radius: 12px; cursor: pointer; backdrop-filter: blur(5px); }

        .subject-tabs {
            display: flex; gap: 10px; overflow-x: auto; padding-bottom: 15px;
            margin: 0 -10px; padding-left: 20px; padding-right: 20px; scrollbar-width: none;
        }
        .subject-tabs::-webkit-scrollbar { display: none; }
        .subject-tab {
            background: rgba(255,255,255,0.2); color: rgba(255,255,255,0.9);
            padding: 6px 16px; border-radius: 20px; font-size: 14px; white-space: nowrap;
            transition: all 0.3s; border: 1px solid transparent;
        }
        .subject-tab.active { background: white; color: var(--primary); font-weight: 700; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

        .info-bar {
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(0,0,0,0.1); padding: 5px; border-radius: 16px; margin-bottom: 15px;
        }
        .class-selector { display: flex; background: rgba(255,255,255,0.2); border-radius: 12px; padding: 2px; overflow-x: auto; max-width: 60%; }
        .class-btn { padding: 6px 12px; font-size: 13px; color: rgba(255,255,255,0.8); border-radius: 10px; white-space: nowrap; transition: all 0.2s; }
        .class-btn.active { background: white; color: var(--primary); font-weight: 600; }
        
        .progress-text { font-size: 13px; margin-right: 10px; font-variant-numeric: tabular-nums; }
        .progress-container { height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; overflow: hidden; margin-bottom: 10px; }
        .progress-bar { height: 100%; background: #fff; width: 0%; transition: width 0.3s ease; }
        .progress-bar.complete { background: var(--success); }

        .main-content { padding: 20px 15px 100px; }
        .empty-state { text-align: center; color: var(--text-sub); margin-top: 50px; }
        .empty-btn { margin-top: 20px; background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 20px; }

        .student-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px; }
        .student-card {
            background: var(--card-bg); border-radius: 16px; padding: 15px; display: flex; align-items: center; gap: 12px;
            box-shadow: var(--shadow); transition: transform 0.1s; position: relative; overflow: hidden;
        }
        .student-card:active { transform: scale(0.96); }
        .student-avatar {
            width: 40px; height: 40px; border-radius: 50%; background: #f0f2f5; color: var(--text-sub);
            display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px; flex-shrink: 0;
        }
        .student-info { flex: 1; overflow: hidden; }
        .student-name { font-weight: 600; font-size: 16px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .student-id { font-size: 12px; color: var(--text-sub); }

        .student-card.done { border: 1px solid var(--success); background: #fafffc; }
        .student-card.done .student-avatar { background: var(--success); color: white; }
        .student-card.done .student-name { color: #1b5e20; }
        .check-icon {
            position: absolute; right: 10px; top: 50%; transform: translateY(-50%) scale(0);
            color: var(--success); transition: transform 0.2s;
        }
        .student-card.done .check-icon { transform: translateY(-50%) scale(1); }

        .fab-container {
            position: fixed; bottom: calc(20px + var(--safe-bottom)); left: 50%; transform: translateX(-50%);
            z-index: 90; display: flex; gap: 15px;
        }
        .fab-btn {
            height: 56px; padding: 0 24px; border-radius: 28px; border: none;
            background: var(--text-main); color: white; font-weight: 600; font-size: 16px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 8px; cursor: pointer;
        }
        .fab-btn.primary { background: var(--primary); }

        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4);
            z-index: 200; backdrop-filter: blur(3px); display: flex; align-items: flex-end; justify-content: center;
        }
        .modal-sheet {
            background: white; width: 100%; border-radius: 24px 24px 0 0; padding: 25px;
            box-sizing: border-box; animation: slideUp 0.3s ease; max-height: 90vh; overflow-y: auto;
        }
        .modal-center {
            background: white; width: 85%; max-width: 400px; border-radius: 20px; padding: 25px;
            margin-bottom: auto; margin-top: auto; animation: popIn 0.3s ease;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .menu-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
        .menu-item {
            display: flex; flex-direction: column; align-items: center; gap: 8px;
            padding: 15px; background: #f8f9fa; border-radius: 12px; color: var(--text-main); font-size: 13px;
        }
        .menu-item:active { background: #e2e6ea; }
        .menu-icon { font-size: 26px; color: var(--primary); }

        .class-manage-list { margin: 15px 0; max-height: 300px; overflow-y: auto; }
        .class-manage-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px; border-bottom: 1px solid #eee;
        }
        .btn-delete { color: var(--danger); background: none; border: none; padding: 8px; }
        
        .config-box { background: #f5f5f5; padding: 15px; border-radius: 12px; margin-bottom: 15px; margin-top: 10px; }
        .input-group { margin-bottom: 10px; }
        .input-group label { display: block; font-size: 12px; color: #666; margin-bottom: 4px; }
        .input-field { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        
        .sync-actions { display: flex; gap: 10px; margin-top: 15px; }
        .btn-full { flex: 1; padding: 12px; border-radius: 10px; border: none; font-weight: 600; cursor: pointer; }
        .btn-blue { background: #e3f2fd; color: #1976d2; }
        .btn-purple { background: #f3e5f5; color: #7b1fa2; }
        .btn-logout { width: 100%; padding: 15px; background: #ffebee; color: var(--danger); border: none; margin-top: 15px; font-weight: 600; border-radius: 12px; }

        .scanner-overlay { position: fixed; inset: 0; background: black; z-index: 300; }
        .scan-frame {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 70%; height: 300px; border: 2px solid rgba(255,255,255,0.6); border-radius: 20px;
        }
        .scan-frame::after {
            content:''; position: absolute; top: 10%; left: 5%; right: 5%; height: 2px;
            background: #00c853; box-shadow: 0 0 10px #00c853; animation: scan 2s infinite;
        }
        @keyframes scan { 0% {top:10%; opacity:0} 50% {opacity:1} 100% {top:90%; opacity:0} }
        .scan-close {
            position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%);
            padding: 10px 30px; border-radius: 30px; border: 1px solid white; background: rgba(0,0,0,0.5); color: white;
        }

        .toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px);
            background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 50px; font-size: 14px;
            z-index: 2000; transition: transform 0.3s; display: flex; align-items: center; gap: 8px;
        }
        .toast.show { transform: translateX(-50%) translateY(0); }
        .toast.success { background: #00c853; }
        .toast.error { background: #d32f2f; }

        #print-area { display: none; }
        @media print {
            body > * { display: none; }
            #print-area { display: block; width: 100%; }
            .qr-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
            .qr-card { border: 1px dashed #ccc; padding: 10px; text-align: center; page-break-inside: avoid; }
            .qr-img-container img { margin: 0 auto; }
        }
    </style>
</head>
<body>
    <div id="app">
        <input type="file" id="file-upload" accept=".xlsx, .xls" @change="handleFileUpload" style="display:none" />
        
        <!-- 认证界面 (登录/注册) -->
        <div v-if="!isLoggedIn" class="auth-overlay">
            <div class="auth-card">
                <div class="auth-title">{{ isRegistering ? '注册新教师' : '教师登录' }}</div>
                
                <input class="auth-input" v-model="authForm.username" placeholder="请输入用户名" />
                <input class="auth-input" v-model="authForm.password" type="password" placeholder="请输入密码" />
                
                <!-- 注册时的班级选择 -->
                <div v-if="isRegistering">
                    <div style="font-size:14px; margin-bottom:5px; color:#666;">请选择您任教的班级:</div>
                    <div class="class-select-group">
                        <div v-if="allClassList.length === 0" style="color:#999; font-size:12px; text-align:center;">
                            系统暂无班级数据<br>请先登录已有账号导入名单<br>或直接注册后在后台导入
                        </div>
                        <div v-for="cls in allClassList" :key="cls" class="checkbox-item">
                            <input type="checkbox" :id="'chk-'+cls" :value="cls" v-model="authForm.selectedClasses">
                            <label :for="'chk-'+cls">{{ cls }}班</label>
                        </div>
                    </div>
                </div>

                <button class="auth-btn" @click="handleAuth" :disabled="authLoading">
                    {{ authLoading ? '处理中...' : (isRegistering ? '立即注册' : '登录') }}
                </button>
                <button class="auth-btn secondary" @click="toggleAuthMode" :disabled="authLoading">
                    {{ isRegistering ? '已有账号？去登录' : '没有账号？去注册' }}
                </button>
            </div>
            <div style="margin-top:20px; font-size:12px; opacity:0.8;">作业登记系统 Pro</div>
        </div>

        <!-- 主界面 (登录后显示) -->
        <template v-else>
            <header class="header-section">
                <div class="nav-top">
                    <div class="app-title">
                        <span class="material-icons-round">folder_shared</span>
                        全科作业登记
                    </div>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span class="user-info">{{ currentUser.username }}</span>
                        <button class="menu-btn" @click="showMenu = true">
                            <span class="material-icons-round">tune</span>
                        </button>
                    </div>
                </div>

                <div class="subject-tabs">
                    <div v-for="sub in subjects" :key="sub" class="subject-tab" 
                        :class="{active: currentSubject === sub}" @click="currentSubject = sub">
                        {{ sub }}
                    </div>
                </div>

                <div class="progress-container">
                    <div class="progress-bar" :class="{complete: percentage === 100}" :style="{width: percentage + '%'}"></div>
                </div>

                <div class="info-bar">
                    <div class="class-selector">
                        <!-- 只显示该用户有权限的班级 -->
                        <div v-if="allowedClassList.length === 0" style="padding:5px; font-size:12px; color:rgba(255,255,255,0.7);">
                            无负责班级
                        </div>
                        <div v-for="cls in allowedClassList" :key="cls" class="class-btn" 
                            :class="{active: currentClass === cls}" @click="currentClass = cls">
                            {{ cls }}班
                        </div>
                    </div>
                    <div class="progress-text">
                        {{ currentSubject }}：{{ submittedCount }}/{{ currentList.length }}
                    </div>
                </div>
            </header>

            <main class="main-content">
                <div v-if="currentList.length === 0" class="empty-state">
                    <span class="material-icons-round" style="font-size: 48px; opacity: 0.3;">group_off</span>
                    <p>当前班级无名单或您未选择班级</p>
                    <button class="empty-btn" @click="showMenu = true">菜单设置</button>
                </div>

                <div class="student-grid" v-else>
                    <div v-for="s in currentList" :key="s.uid" class="student-card" 
                        :class="{done: s.submitted}" @click="toggleStatus(s)">
                        <div class="student-avatar">{{ s.no }}</div>
                        <div class="student-info">
                            <div class="student-name">{{ s.name }}</div>
                            <div class="student-id">{{ s.classId }}班 {{ s.no }}号</div>
                        </div>
                        <span class="material-icons-round check-icon">check_circle</span>
                    </div>
                </div>
            </main>

            <div class="fab-container">
                <button class="fab-btn primary" @click="startScan">
                    <span class="material-icons-round">qr_code_scanner</span>
                    扫码登记
                </button>
            </div>
        </template>

        <!-- 菜单 -->
        <div class="modal-overlay" v-if="showMenu" @click.self="showMenu = false">
            <div class="modal-sheet">
                <div style="font-size:18px; font-weight:700; margin-bottom:20px;">系统菜单</div>
                <div class="menu-grid">
                    <div class="menu-item" @click="triggerFileUpload">
                        <span class="material-icons-round menu-icon">upload_file</span><span>导入名单</span>
                    </div>
                    <div class="menu-item" @click="showClassManager = true; showMenu = false;">
                        <span class="material-icons-round menu-icon" style="color:#607d8b">manage_accounts</span><span>班级管理</span>
                    </div>
                    <div class="menu-item" @click="exportExcel">
                        <span class="material-icons-round menu-icon">file_download</span><span>导出统计</span>
                    </div>
                    <div class="menu-item" @click="preparePrint">
                        <span class="material-icons-round menu-icon">print</span><span>打印二维码</span>
                    </div>
                    <div class="menu-item" @click="resetCurrentSubject">
                        <span class="material-icons-round menu-icon" style="color:orange">restart_alt</span><span>重置{{currentSubject}}</span>
                    </div>
                    <div class="menu-item" @click="showUserSetting = true; showMenu = false;">
                        <span class="material-icons-round menu-icon" style="color:#7b1fa2">perm_identity</span><span>账户设置</span>
                    </div>
                </div>

                <div style="border-top:1px solid #eee; padding-top:20px;">
                    <div style="font-weight:600;">云端数据同步</div>
                    <div class="sync-actions">
                        <button class="btn-full btn-blue" @click="uploadData" :disabled="loading">
                            {{ loading ? '同步中...' : '上传数据' }}
                        </button>
                        <button class="btn-full btn-purple" @click="downloadData" :disabled="loading">
                            {{ loading ? '同步中...' : '下载数据' }}
                        </button>
                    </div>
                    <button class="btn-logout" @click="logout">退出登录</button>
                </div>
                <button style="width:100%; padding:15px; border:none; background:white; color:#666;" @click="showMenu = false">关闭</button>
            </div>
        </div>

        <!-- 班级管理 -->
        <div class="modal-overlay" v-if="showClassManager" @click.self="showClassManager = false">
            <div class="modal-center">
                <div style="font-size:18px; font-weight:700;">班级名单管理</div>
                <div class="class-manage-list">
                    <div v-if="allClassList.length === 0" style="text-align:center; padding:20px; color:#999;">暂无数据</div>
                    <div v-else v-for="cls in allClassList" :key="'m-'+cls" class="class-manage-item">
                        <span style="font-weight:600;">{{ cls }}班</span>
                        <button class="btn-delete" @click="deleteClass(cls)"><span class="material-icons-round">delete</span></button>
                    </div>
                </div>
                <button style="width:100%; padding:15px; background:none; border:none; color:#666;" @click="showClassManager = false">关闭</button>
            </div>
        </div>

        <!-- 用户班级设置 -->
        <div class="modal-overlay" v-if="showUserSetting" @click.self="showUserSetting = false">
            <div class="modal-center">
                <div style="font-size:18px; font-weight:700; margin-bottom:15px;">设置我的班级</div>
                <div class="class-select-group" style="max-height:300px;">
                    <div v-for="cls in allClassList" :key="'set-'+cls" class="checkbox-item">
                        <input type="checkbox" :id="'set-chk-'+cls" :value="cls" v-model="currentUser.classes">
                        <label :for="'set-chk-'+cls">{{ cls }}班</label>
                    </div>
                </div>
                <button class="btn-full btn-blue" @click="updateUserClasses">保存修改</button>
                <button style="width:100%; padding:15px; background:none; border:none; color:#666;" @click="showUserSetting = false">取消</button>
            </div>
        </div>

        <!-- 扫描 & Toast & Print (保持不变) -->
        <div v-if="scanning" class="scanner-overlay"><div id="reader" style="width:100%;height:100%"></div><div class="scan-frame"></div><button class="scan-close" @click="stopScan">关闭</button></div>
        <div class="toast" :class="{show: toast.show, success: toast.type === 'success', error: toast.type === 'error'}"><span class="material-icons-round">{{ toast.type === 'success'?'check_circle':'info' }}</span><span>{{ toast.msg }}</span></div>
        <div id="print-area"><div style="text-align:center;font-size:24px;margin-bottom:20px;">{{currentClass}}班 学生二维码</div><div class="qr-grid"><div v-for="s in currentList" :key="'qr-'+s.uid" class="qr-card"><div class="qr-img-container" :id="'qrcode-'+s.uid"></div><div style="font-weight:bold;">{{s.name}}</div><div style="font-size:12px;">{{s.classId}}班 {{s.no}}号</div></div></div></div>

    </div>

    <script>
        const { createApp, ref, computed, onMounted, nextTick, watch } = Vue;

        const CONFIG = { binId: '6923c68543b1c97be9c111de', apiKey: '$2a$10$PzeIEyOc63K1OPPrCb1Y.uzvCUXWUEfsYmu.7gkaCMTsjJ3FLWM3u' };

        createApp({
            setup() {
                const subjects = ['语文', '数学', '英语', '科学', '社会'];
                const currentSubject = ref('语文');
                const currentClass = ref('');
                
                // 数据核心
                const roster = ref([]); // 全校名单
                const records = ref({}); // 全校记录
                const users = ref([]); // 用户列表 [{username, password, classes:[]}]
                
                // 状态
                const isLoggedIn = ref(false);
                const currentUser = ref(null); // {username, classes:[]}
                const isRegistering = ref(false);
                const authLoading = ref(false);
                const authForm = ref({ username: '', password: '', selectedClasses: [] });
                
                const showMenu = ref(false);
                const showClassManager = ref(false);
                const showUserSetting = ref(false);
                const scanning = ref(false);
                const loading = ref(false);
                const toast = ref({ show: false, msg: '', type: 'info' });
                let html5QrcodeScanner = null;

                const initRecords = () => subjects.forEach(sub => { if (!records.value[sub]) records.value[sub] = {}; });

                // --- 核心计算属性 ---
                // 所有存在的班级
                const allClassList = computed(() => [...new Set(roster.value.map(s => s.classId))].sort());
                
                // 当前用户有权限看到的班级
                const allowedClassList = computed(() => {
                    if (!currentUser.value || !currentUser.value.classes) return [];
                    // 取交集：既在名单里存在，又在用户权限里
                    return allClassList.value.filter(c => currentUser.value.classes.includes(c));
                });

                // 当前显示的列表 (受权限控制)
                const currentList = computed(() => {
                    if (!currentClass.value) return [];
                    // 安全检查：如果当前选中的班级不在权限内，返回空
                    if (!allowedClassList.value.includes(currentClass.value)) return [];
                    
                    const list = roster.value.filter(s => s.classId == currentClass.value);
                    return list.map(s => ({
                        ...s,
                        submitted: !!(records.value[currentSubject.value] && records.value[currentSubject.value][s.uid])
                    }));
                });

                const submittedCount = computed(() => currentList.value.filter(s => s.submitted).length);
                const percentage = computed(() => currentList.value.length === 0 ? 0 : Math.round((submittedCount.value / currentList.value.length) * 100));

                // --- 认证逻辑 ---
                const toggleAuthMode = () => { isRegistering.value = !isRegistering.value; authForm.value.selectedClasses = []; };

                const handleAuth = async () => {
                    if(!authForm.value.username || !authForm.value.password) return showToast("请输入账号密码", "error");
                    authLoading.value = true;

                    try {
                        // 1. 先拉取最新数据，确保用户列表是最新的
                        await fetchCloudData(true); // true = silent loading

                        const { username, password, selectedClasses } = authForm.value;
                        const user = users.value.find(u => u.username === username);

                        if (isRegistering.value) {
                            if (user) throw new Error("用户名已存在");
                            // 注册新用户
                            const newUser = { username, password, classes: selectedClasses };
                            users.value.push(newUser);
                            // 立即保存到云端
                            await saveToCloud();
                            currentUser.value = newUser;
                            isLoggedIn.value = true;
                            showToast("注册成功", "success");
                        } else {
                            // 登录
                            if (!user || user.password !== password) throw new Error("账号或密码错误");
                            currentUser.value = user;
                            isLoggedIn.value = true;
                            showToast("登录成功", "success");
                        }

                        // 登录后逻辑：自动选择第一个有权限的班级
                        if (allowedClassList.value.length > 0) currentClass.value = allowedClassList.value[0];
                        
                    } catch (e) {
                        showToast(e.message, "error");
                    } finally {
                        authLoading.value = false;
                    }
                };

                const logout = () => {
                    isLoggedIn.value = false;
                    currentUser.value = null;
                    authForm.value = { username: '', password: '', selectedClasses: [] };
                    showMenu.value = false;
                    showToast("已退出登录");
                };

                const updateUserClasses = async () => {
                    // 更新当前用户的班级权限并保存到云端
                    // 在 users 数组中找到当前用户并更新
                    const idx = users.value.findIndex(u => u.username === currentUser.value.username);
                    if (idx !== -1) {
                        users.value[idx].classes = currentUser.value.classes;
                        await saveToCloud();
                        showToast("设置已保存", "success");
                        showUserSetting.value = false;
                        // 如果当前班级不在新权限内，重置
                        if (!allowedClassList.value.includes(currentClass.value)) {
                            currentClass.value = allowedClassList.value[0] || '';
                        }
                    }
                };

                // --- 云端交互 ---
                const fetchCloudData = async (silent = false) => {
                    if(!silent) loading.value = true;
                    try {
                        const res = await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.binId}/latest`, {
                            headers: { 'X-Master-Key': CONFIG.apiKey }
                        });
                        if(!res.ok) throw new Error("网络错误");
                        const json = await res.json();
                        const data = json.record || {};
                        
                        if(data.roster) roster.value = data.roster;
                        if(data.records) records.value = data.records;
                        if(data.users) users.value = data.users;
                        
                        initRecords();
                        // 如果已登录，需同步更新当前用户的引用
                        if (isLoggedIn.value) {
                            const updatedUser = users.value.find(u => u.username === currentUser.value.username);
                            if (updatedUser) currentUser.value = updatedUser;
                        }
                    } catch(e) { 
                        if(!silent) showToast("数据同步失败", "error"); 
                        console.error(e);
                    } finally { 
                        if(!silent) loading.value = false; 
                    }
                };

                const saveToCloud = async () => {
                    loading.value = true;
                    try {
                        await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.binId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json', 'X-Master-Key': CONFIG.apiKey },
                            body: JSON.stringify({ 
                                updatedAt: Date.now(), 
                                roster: roster.value, 
                                records: records.value,
                                users: users.value // 保存用户数据
                            })
                        });
                    } catch(e) { throw e; } 
                    finally { loading.value = false; }
                };

                const uploadData = async () => {
                    try { await saveToCloud(); showToast("上传成功", "success"); } 
                    catch(e) { showToast("上传失败", "error"); }
                };

                const downloadData = async () => {
                    if(!confirm("覆盖本地数据？")) return;
                    await fetchCloudData();
                    showToast("下载成功", "success");
                };

                // --- 其他业务逻辑 ---
                const showToast = (msg, type='info') => { toast.value = { show: true, msg, type }; setTimeout(() => toast.value.show = false, 2000); };
                const toggleStatus = (s) => {
                    const sub = currentSubject.value;
                    if(records.value[sub][s.uid]) delete records.value[sub][s.uid];
                    else { records.value[sub][s.uid]=true; if(navigator.vibrate) navigator.vibrate(50); }
                };
                
                // 导入
                const triggerFileUpload = () => { const el = document.getElementById('file-upload'); if(el) el.click(); };
                const handleFileUpload = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (evt) => {
                        try {
                            const wb = XLSX.read(new Uint8Array(evt.target.result), { type: 'array' });
                            const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                            const newRoster = [];
                            json.forEach(row => {
                                const c = row['班级']||row['class']; const n = row['学号']||row['no']; const name = row['姓名']||row['name'];
                                if(c && name) newRoster.push({ classId:String(c).trim(), no:String(n||'').trim().padStart(2,'0'), name, uid:`${String(c).trim()}-${String(n||'').trim().padStart(2,'0')}` });
                            });
                            if (newRoster.length > 0) {
                                if(confirm(`识别到 ${newRoster.length} 人，确定导入？`)) {
                                    const exist = new Set(roster.value.map(s=>s.uid));
                                    roster.value = [...roster.value, ...newRoster.filter(s=>!exist.has(s.uid))];
                                    showToast("导入成功", "success");
                                    // 自动更新当前用户权限，如果他是刚注册且没选班级
                                    if(currentUser.value.classes.length === 0) {
                                        showUserSetting.value = true;
                                        showToast("请在设置中勾选您的班级", "info");
                                    }
                                }
                            } else showToast("格式错误", "error");
                        } catch (err) { showToast("解析失败", "error"); }
                        e.target.value = ''; showMenu.value = false;
                    };
                    reader.readAsArrayBuffer(file);
                };

                const deleteClass = (c) => {
                    if(confirm(`删除 ${c} 班？`)) {
                        const toDel = roster.value.filter(s=>s.classId===c).map(s=>s.uid);
                        roster.value = roster.value.filter(s=>s.classId!==c);
                        subjects.forEach(sub => { if(records.value[sub]) toDel.forEach(uid => delete records.value[sub][uid]); });
                        if(currentClass.value===c) currentClass.value = allowedClassList.value[0]||'';
                        showToast("已删除", "success");
                    }
                };

                const exportExcel = () => {
                    const data = currentList.value.map(s => ({ "班级":s.classId, "学号":s.no, "姓名":s.name, "科目":currentSubject.value, "状态":s.submitted?"已交":"未交" }));
                    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), currentSubject.value);
                    XLSX.writeFile(wb, `${currentSubject.value}_统计.xlsx`); showMenu.value=false;
                };
                const resetCurrentSubject = () => { if(confirm("重置当前科目？")) { records.value[currentSubject.value]={}; showToast("已重置"); showMenu.value=false; } };

                // 扫码
                const startScan = () => { scanning.value=true; nextTick(()=>{ html5QrcodeScanner=new Html5Qrcode("reader"); html5QrcodeScanner.start({facingMode:"environment"},{fps:10,qrbox:{width:250,height:250}}, onScanSuccess); }); };
                const stopScan = () => { if(html5QrcodeScanner) html5QrcodeScanner.stop().then(()=>{html5QrcodeScanner.clear();scanning.value=false;}); else scanning.value=false; };
                let lastUid=null, lastT=0;
                const onScanSuccess = (txt) => {
                    if(txt===lastUid && Date.now()-lastT<2000) return; lastUid=txt; lastT=Date.now();
                    const s = roster.value.find(i=>i.uid===txt);
                    if(!s) return showToast("无效码", "error");
                    // 检查该班级是否在用户权限内
                    if(!allowedClassList.value.includes(s.classId)) return showToast(`您没有 ${s.classId} 班的权限`, "error");
                    
                    const sub = currentSubject.value;
                    if(!records.value[sub][txt]) { records.value[sub][txt]=true; if(navigator.vibrate) navigator.vibrate(200); showToast(`${s.name} ${sub} OK`, "success"); }
                    else showToast("已交", "info");
                };

                const preparePrint = async () => {
                    showMenu.value=false; if(currentList.value.length===0) return showToast("无数据");
                    await nextTick(); document.querySelectorAll('.qr-img-container').forEach(e=>e.innerHTML='');
                    setTimeout(() => { currentList.value.forEach(s => { const el = document.getElementById('qrcode-'+s.uid); if(el) new QRCode(el, { text:s.uid, width:120, height:120, correctLevel:QRCode.CorrectLevel.M }); }); setTimeout(()=>window.print(),500); }, 500);
                };

                // 启动时尝试静默获取数据，判断是否需要登录
                onMounted(() => {
                    fetchCloudData(true);
                });

                return {
                    subjects, currentSubject, currentClass, allowedClassList, allClassList, currentList, percentage, submittedCount,
                    isLoggedIn, currentUser, isRegistering, authForm, authLoading,
                    showMenu, showClassManager, showUserSetting, scanning, loading, toast,
                    handleAuth, toggleAuthMode, logout, updateUserClasses,
                    toggleStatus, startScan, stopScan, triggerFileUpload, handleFileUpload, deleteClass,
                    exportExcel, resetCurrentSubject, uploadData, downloadData, preparePrint
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
